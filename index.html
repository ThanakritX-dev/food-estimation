<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Food Estimator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
font-family:Arial;
background:#f4f6f9;
text-align:center;
padding:20px;
}
.section{
background:white;
padding:20px;
margin:15px auto;
width:90%;
max-width:500px;
border-radius:10px;
box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
button{
padding:10px 15px;
margin:5px;
border:none;
border-radius:5px;
background:#3498db;
color:white;
cursor:pointer;
}
button:hover{
background:#2980b9;
}
canvas{
max-width:100%;
margin-top:10px;
}
</style>
</head>
<body>

<h2>Food Estimator Dashboard</h2>

<div class="section">
<h3>เลือกคนไข้</h3>
<select id="patientSelect">
<option value="">-- เลือกคนไข้ --</option>
</select>
<div id="patientInfo"></div>
</div>

<div class="section">
<h3>Before</h3>
<input type="file" accept="image/*" id="beforeInput">
<img id="beforeImg" width="200">
</div>

<div class="section">
<h3>After</h3>
<input type="file" accept="image/*" id="afterInput">
<img id="afterImg" width="200">
</div>

<div class="section">
<button onclick="compareImages()">คำนวณ</button>
<h3 id="result"></h3>
<canvas id="diffCanvas"></canvas>
</div>

<div class="section">
<h3>Dashboard</h3>
<canvas id="chartCanvas"></canvas>
</div>

<script>

const scriptURL="https://script.google.com/macros/s/AKfycbzSEKwDgxyvTFj2M-5d-Xfp6aLrB4946GuloIb0wzqyYTrk9EivMbkU0oUuarAqXoeb8Q/exec";

let selectedData={};
let diffPercent=0;
let diffPixel=0;

function loadPatients(){
fetch(scriptURL+"?type=patients")
.then(res=>res.json())
.then(data=>{
let select=document.getElementById("patientSelect");
select.innerHTML='<option value="">-- เลือกคนไข้ --</option>';

for(let i=1;i<data.length;i++){
let row=data[i];
let option=document.createElement("option");
option.value=JSON.stringify(row);
option.text=row[0];
select.appendChild(option);
}
});
}

document.getElementById("patientSelect").addEventListener("change",function(){
if(!this.value) return;
let row=JSON.parse(this.value);

let bmi=(row[2]/((row[3]/100)*(row[3]/100))).toFixed(2);

selectedData={
name:row[0],
dx:row[1],
weight:row[2],
height:row[3],
bmi:bmi
};

document.getElementById("patientInfo").innerHTML=
"DX: "+row[1]+"<br>Weight: "+row[2]+" kg"+
"<br>Height: "+row[3]+" cm"+
"<br>BMI: "+bmi;

loadChart(row[0]);
});

function loadImage(input,img){
let file=input.files[0];
let reader=new FileReader();
reader.onload=function(e){
img.src=e.target.result;
}
reader.readAsDataURL(file);
}

beforeInput.onchange=()=>loadImage(beforeInput,beforeImg);
afterInput.onchange=()=>loadImage(afterInput,afterImg);

function compareImages(){

let img1=beforeImg;
let img2=afterImg;

let canvas=document.getElementById("diffCanvas");
let ctx=canvas.getContext("2d");

canvas.width=img1.width;
canvas.height=img1.height;

ctx.drawImage(img1,0,0);

let data1=ctx.getImageData(0,0,canvas.width,canvas.height);

ctx.drawImage(img2,0,0);
let data2=ctx.getImageData(0,0,canvas.width,canvas.height);

let diffCount=0;

for(let i=0;i<data1.data.length;i+=4){
let r1=data1.data[i];
let r2=data2.data[i];

if(Math.abs(r1-r2)>30){
data1.data[i]=255;
data1.data[i+1]=0;
data1.data[i+2]=0;
diffCount++;
}
}

ctx.putImageData(data1,0,0);

diffPixel=diffCount;
diffPercent=((diffCount/(canvas.width*canvas.height))*100).toFixed(2);

document.getElementById("result").innerHTML=
"Difference: "+diffPercent+"%";

saveToSheet();
}

function saveToSheet(){

fetch(scriptURL,{
method:"POST",
body:JSON.stringify({
name:selectedData.name,
dx:selectedData.dx,
weight:selectedData.weight,
height:selectedData.height,
bmi:selectedData.bmi,
diffPercent:diffPercent,
pixel:diffPixel
})
});
}

function loadChart(name){

fetch(scriptURL+"?type=meals")
.then(res=>res.json())
.then(data=>{

let labels=[];
let values=[];

for(let i=1;i<data.length;i++){
if(data[i][1]===name){
labels.push(new Date(data[i][0]).toLocaleDateString());
values.push(data[i][6]);
}
}

document.getElementById("chartCanvas").remove();
let canvas=document.createElement("canvas");
canvas.id="chartCanvas";
document.querySelectorAll(".section")[4].appendChild(canvas);

new Chart(canvas,{
type:"line",
data:{
labels:labels,
datasets:[{
label:"Diff %",
data:values
}]
}
});
});
}

window.onload=function(){
loadPatients();
}

</script>

</body>
</html>
